<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Debug Pulse</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; text-align: center; }
        video { width: 150px; height: 150px; border: 2px solid #333; border-radius: 10px; object-fit: cover; margin-top: 10px; }
        #bpm { font-size: 60px; margin: 20px; color: red; height: 80px; }
        button { padding: 15px; background: #222; color: #fff; border: 1px solid #555; border-radius: 10px; margin: 10px; }
    </style>
</head>
<body>
    <div id="bpm">--</div>
    <video id="preview" autoplay playsinline></video><br>
    <button onclick="switchCamera()">Сменить камеру</button>
    <p id="info">Приложи палец к линзе так, чтобы экран стал красным</p>
    <canvas id="analyzer" width="10" height="10" style="display:none"></canvas>

    <script>
        const video = document.getElementById('preview');
        const canvas = document.getElementById('analyzer');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const bpmDisplay = document.getElementById('bpm');
        
        let currentStream = null;
        let useFront = false;

        async function init(facing) {
            if (currentStream) currentStream.getTracks().forEach(t => t.stop());
            
            const constraints = {
                video: { facingMode: facing ? "user" : "environment" },
                audio: false
            };

            try {
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                process();
            } catch (e) {
                alert("Ошибка: " + e);
            }
        }

        function switchCamera() {
            useFront = !useFront;
            init(useFront);
        }

        function process() {
            if (!currentStream.active) return;
            
            ctx.drawImage(video, 0, 0, 10, 10);
            const data = ctx.getImageData(0, 0, 10, 10).data;
            
            // Считаем сумму красного
            let r = 0;
            for (let i = 0; i < data.length; i += 4) r += data[i];
            
            // Если экран стал очень красным (палец на камере)
            if (r > 15000) { // Порог зависит от освещенности
                bpmDisplay.innerText = "❤️";
                if (navigator.vibrate) navigator.vibrate(50);
                setTimeout(() => { bpmDisplay.innerText = " "; }, 150);
            } else {
                bpmDisplay.innerText = "WAIT";
            }
            
            requestAnimationFrame(process);
        }

        init(false);
    </script>
</body>
</html>
